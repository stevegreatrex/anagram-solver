<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anagram Solver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
            overflow: hidden;
        }
        .letter-tile {
            /* Smooth transitions for position, size, and opacity */
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        /* New class to handle the dimmed state */
        .letter-tile.dimmed {
            opacity: 0.3;
        }
        #appContainer {
            transition: height 0.2s ease-in-out;
        }
        #resultsModal.hidden {
            display: none;
        }
        .modal-content {
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
        }
        #resultsModal:not(.hidden) .modal-content {
            transform: translateY(0);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <div id="appContainer" class="w-full">
        <div class="flex flex-col p-4 md:p-6 h-full">
        
            <div id="letterContainer" class="relative w-full flex-grow bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden">
                <!-- Letters will be dynamically inserted here -->
            </div>

            <div class="flex items-center gap-3 mt-4">
                <input type="text" id="letterInput" placeholder="Type letters here..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="flex-grow w-full px-5 py-3 text-lg bg-white dark:bg-gray-800 border-2 border-transparent rounded-xl shadow-lg focus:ring-4 focus:ring-blue-500/30 focus:border-blue-500 dark:focus:border-blue-400 outline-none transition duration-300">
                
                <button id="findAnagramsButton" class="flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-xl shadow-lg transition-all duration-300 transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                    </svg>
                </button>

                <button id="repositionButton" class="flex-shrink-0 bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 font-bold p-3 rounded-xl shadow-lg transition-all duration-300 transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M20 4h-5v5M4 20h5v-5" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Gemini Results Modal -->
    <div id="resultsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
        <div class="modal-content w-full bg-gray-100 dark:bg-gray-900 rounded-t-2xl shadow-lg p-4 max-h-[75vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white">âœ¨ Possible Words</h2>
                <button id="closeModalButton" class="text-gray-500 hover:text-gray-800 dark:hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="loader" class="flex justify-center items-center h-32">
                <div class="loader"></div>
            </div>
            <div id="resultsContent" class="overflow-y-auto flex flex-wrap gap-2">
                <!-- Anagrams will be inserted here -->
            </div>
        </div>
    </div>


    <script>
        const letterInput = document.getElementById('letterInput');
        const repositionButton = document.getElementById('repositionButton');
        const letterContainer = document.getElementById('letterContainer');
        const appContainer = document.getElementById('appContainer');
        const findAnagramsButton = document.getElementById('findAnagramsButton');
        const resultsModal = document.getElementById('resultsModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const resultsContent = document.getElementById('resultsContent');
        const loader = document.getElementById('loader');

        let currentLetters = '';

        const calculateTileSize = (letterCount, containerWidth, containerHeight) => {
            if (letterCount === 0) return { tileSize: 60, fontSize: 36 };
            const containerArea = containerWidth * containerHeight;
            const safeAreaPerTile = (containerArea / letterCount) * 0.7; 
            let tileSize = Math.sqrt(safeAreaPerTile);
            const minSize = 24;
            const maxSize = 90;
            tileSize = Math.max(minSize, Math.min(tileSize, maxSize));
            const fontSize = tileSize * 0.6;
            return { tileSize, fontSize };
        };

        const checkOverlap = (rect1, rect2) => {
            const padding = 5;
            return (
                rect1.x < rect2.x + rect2.width + padding &&
                rect1.x + rect1.width + padding > rect2.x &&
                rect1.y < rect2.y + rect2.height + padding &&
                rect1.y + rect1.height + padding > rect2.y
            );
        };

        const scrambleAndPlaceLetters = (letters) => {
            letterContainer.innerHTML = '';
            if (letters.length === 0) return;

            const containerWidth = letterContainer.offsetWidth;
            const containerHeight = letterContainer.offsetHeight;
            
            let placementSuccess = false;
            let { tileSize, fontSize } = calculateTileSize(letters.length, containerWidth, containerHeight);
            const minTileSize = 10;

            while (!placementSuccess && tileSize >= minTileSize) {
                placementSuccess = true;
                const placedTiles = [];
                const tileElements = [];

                for (const char of letters) {
                    if (char === ' ') continue;
                    const letterTile = document.createElement('div');
                    letterTile.textContent = char.toUpperCase();
                    letterTile.className = 'letter-tile absolute flex items-center justify-center bg-blue-500 text-white rounded-lg shadow-lg font-semibold select-none cursor-pointer';
                    letterTile.style.width = `${tileSize}px`;
                    letterTile.style.height = `${tileSize}px`;
                    letterTile.style.fontSize = `${fontSize}px`;

                    // --- NEW: Add click listener to toggle opacity ---
                    letterTile.addEventListener('click', () => {
                        letterTile.classList.toggle('dimmed');
                    });

                    tileElements.push(letterTile);
                }

                for (const letterTile of tileElements) {
                    let positionIsValid = false;
                    let attempts = 0;
                    const maxAttempts = 200;

                    while (!positionIsValid && attempts < maxAttempts) {
                        attempts++;
                        const randomX = Math.random() * (containerWidth - tileSize);
                        const randomY = Math.random() * (containerHeight - tileSize);
                        const newTileRect = { x: randomX, y: randomY, width: tileSize, height: tileSize };
                        
                        let hasOverlap = false;
                        for (const placedRect of placedTiles) {
                            if (checkOverlap(newTileRect, placedRect)) {
                                hasOverlap = true;
                                break;
                            }
                        }
                        if (!hasOverlap) {
                            positionIsValid = true;
                            letterTile.dataset.x = randomX;
                            letterTile.dataset.y = randomY;
                            placedTiles.push(newTileRect);
                        }
                    }

                    if (!positionIsValid) {
                        placementSuccess = false;
                        break; 
                    }
                }

                if (!placementSuccess) {
                    tileSize *= 0.95;
                    fontSize = tileSize * 0.6;
                } else {
                    tileElements.forEach(tile => {
                        tile.style.left = `${tile.dataset.x}px`;
                        tile.style.top = `${tile.dataset.y}px`;
                        letterContainer.appendChild(tile);
                    });
                }
            }

            if (!placementSuccess) {
                console.error("Could not fit all letters on screen.");
            }
        };

        const handleInput = () => {
            currentLetters = letterInput.value.replace(/\s/g, '');
            scrambleAndPlaceLetters(currentLetters);
        };

        const handleRescramble = () => {
            scrambleAndPlaceLetters(currentLetters);
        };
        
        const handleViewportResize = () => {
            appContainer.style.height = `${window.visualViewport.height}px`;
            setTimeout(handleRescramble, 50);
        };

        appContainer.style.height = `${window.visualViewport ? window.visualViewport.height : window.innerHeight}px`;
        letterInput.addEventListener('input', handleInput);
        repositionButton.addEventListener('click', handleRescramble);
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', handleViewportResize);
        } else {
            window.addEventListener('resize', handleRescramble);
        }
        if (letterInput.value) handleInput();

        // --- Gemini API Integration ---

        async function findAnagramsWithGemini(letters) {
            const prompt = `Find all valid English words that can be made using only the letters: ${letters}. List them separated by commas.`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            let response;
            let retries = 3, delay = 1000;
            while (retries > 0) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates[0] && result.candidates[0].content.parts[0].text) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            throw new Error('Invalid response structure from API.');
                        }
                    } else {
                         throw new Error(`API request failed with status ${response.status}`);
                    }
                } catch (error) {
                    console.error(`Attempt failed: ${error.message}`);
                    retries--;
                    if (retries === 0) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        const showModal = () => resultsModal.classList.remove('hidden');
        const hideModal = () => resultsModal.classList.add('hidden');

        const displayResults = (text) => {
            resultsContent.innerHTML = '';
            if (!text || text.trim() === '') {
                 resultsContent.innerHTML = `<p class="text-gray-500 dark:text-gray-400">No words found.</p>`;
                 return;
            }
            const words = text.split(',').map(word => word.trim().toLowerCase()).filter(Boolean);
            const uniqueWords = [...new Set(words)];
            uniqueWords.sort((a,b) => b.length - a.length || a.localeCompare(b));
            
            uniqueWords.forEach(word => {
                const wordEl = document.createElement('div');
                wordEl.textContent = word;
                wordEl.className = 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-1 rounded-md shadow-sm';
                resultsContent.appendChild(wordEl);
            });
        };

        findAnagramsButton.addEventListener('click', async () => {
            if (currentLetters.length < 2) return;
            showModal();
            loader.style.display = 'flex';
            resultsContent.innerHTML = '';
            try {
                const resultText = await findAnagramsWithGemini(currentLetters);
                displayResults(resultText);
            } catch (error) {
                console.error('Failed to get anagrams:', error);
                resultsContent.innerHTML = `<p class="text-red-500">Sorry, something went wrong. Please try again.</p>`;
            } finally {
                loader.style.display = 'none';
            }
        });

        closeModalButton.addEventListener('click', hideModal);
        resultsModal.addEventListener('click', (e) => {
            if (e.target === resultsModal) {
                hideModal();
            }
        });

    </script>
</body>
</html>
